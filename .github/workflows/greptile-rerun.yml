name: greptile-rerun

on:
  workflow_run:
    workflows: [risk-policy-gate]
    types: [completed]

jobs:
  rerun-request:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Check for existing rerun request and post if needed
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = context.payload.workflow_run.head_sha;
            const prNumbers = context.payload.workflow_run.pull_requests.map(pr => pr.number);

            if (prNumbers.length === 0) {
              console.log('No associated PRs â€” skipping rerun request');
              return;
            }

            const marker = '<!-- risk-policy-rerun-request -->';
            const trigger = `sha:${headSha}`;

            for (const prNumber of prNumbers) {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              const alreadyRequested = comments.some(
                c => c.body.includes(marker) && c.body.includes(trigger)
              );

              if (!alreadyRequested) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `${marker}\n@review-agent please re-review\n${trigger}`,
                });
                console.log(`Posted rerun request for PR #${prNumber} at ${headSha}`);
              } else {
                console.log(`Rerun already requested for PR #${prNumber} at ${headSha}`);
              }
            }
