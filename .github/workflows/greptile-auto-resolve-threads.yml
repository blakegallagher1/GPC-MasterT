name: greptile-auto-resolve-threads

on:
  workflow_run:
    workflows: [greptile-rerun]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-resolve:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Auto-resolve bot-only threads
        uses: actions/github-script@v7
        with:
          script: |
            const botUser = 'greptile[bot]';
            const prNumbers = context.payload.workflow_run.pull_requests.map(pr => pr.number);

            for (const prNumber of prNumbers) {
              // Fetch review threads via GraphQL
              const query = `
                query($owner: String!, $repo: String!, $pr: Int!) {
                  repository(owner: $owner, name: $repo) {
                    pullRequest(number: $pr) {
                      reviewThreads(first: 100) {
                        nodes {
                          id
                          isResolved
                          comments(first: 50) {
                            nodes {
                              author { login }
                              body
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const result = await github.graphql(query, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pr: prNumber,
              });

              const threads = result.repository.pullRequest.reviewThreads.nodes;

              for (const thread of threads) {
                if (thread.isResolved) continue;

                const allBot = thread.comments.nodes.every(
                  c => c.author.login === botUser
                );

                if (allBot && thread.comments.nodes.length > 0) {
                  await github.graphql(`
                    mutation($threadId: ID!) {
                      resolveReviewThread(input: { threadId: $threadId }) {
                        thread { id }
                      }
                    }
                  `, { threadId: thread.id });

                  console.log(`Auto-resolved bot-only thread ${thread.id} on PR #${prNumber}`);
                }
              }
            }
