name: risk-policy-gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      risk-tier: ${{ steps.gate.outputs.risk-tier }}
      required-checks: ${{ steps.gate.outputs.required-checks }}
      review-required: ${{ steps.gate.outputs.review-required }}
      risk-score: ${{ steps.gate.outputs.risk-score }}
      risk-explanation: ${{ steps.gate.outputs.risk-explanation }}
      needs-browser-evidence: ${{ steps.gate.outputs.needs-browser-evidence }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm -r build

      - name: Compute changed files
        id: changes
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ',')
          echo "files=${FILES}" >> "$GITHUB_OUTPUT"

      - name: Run risk-policy gate
        id: gate
        run: |
          node --input-type=module <<'EOF'
          import { loadContract, loadHistoricalRiskMetadata, computeRiskAssessment, computeRequiredChecks, needsCodeReviewAgent, assertDocsDriftRules } from './packages/config/dist/index.js';

          const files = process.env.CHANGED_FILES.split(',').filter(Boolean);
          const contract = await loadContract(process.cwd());
          const metadata = await loadHistoricalRiskMetadata(process.cwd());
          const assessment = computeRiskAssessment(files, contract, metadata);
          const tier = assessment.tier;
          const checks = computeRequiredChecks(files, contract, metadata);
          const reviewRequired = needsCodeReviewAgent(files, contract, metadata);

          console.log(`Risk score: ${assessment.score} (threshold=${assessment.threshold})`);
          console.log(`Risk tier: ${tier}`);
          console.log(`Required checks: ${checks.join(', ')}`);
          console.log(`Review agent required: ${reviewRequired}`);
          console.log(`Risk explanation: ${JSON.stringify(assessment.explanation)}`);

          try {
            assertDocsDriftRules(files, contract);
            console.log('Docs-drift check: passed');
          } catch (err) {
            console.error(`Docs-drift check: FAILED â€” ${err.message}`);
            process.exitCode = 1;
          }

          const fs = await import('node:fs');
          const outputFile = process.env.GITHUB_OUTPUT;
          fs.appendFileSync(outputFile, `risk-tier=${tier}\n`);
          fs.appendFileSync(outputFile, `required-checks=${JSON.stringify(checks)}\n`);
          fs.appendFileSync(outputFile, `review-required=${reviewRequired}\n`);
          fs.appendFileSync(outputFile, `risk-score=${assessment.score}\n`);
          fs.appendFileSync(outputFile, `risk-explanation=${JSON.stringify(assessment.explanation)}\n`);

          const uiFlowPatterns = (contract.browserEvidence.requiredFlows || []).flatMap(f => [`**/${f}/**`, `**/${f}`]);
          const uiHighTierPatterns = contract.riskTierRules.high.filter(p =>
            /\blegal.chat\b/.test(p) || /\bweb\b/.test(p) || /\bcheckout\b/.test(p)
          );
          const allUiPatterns = [...uiFlowPatterns, ...uiHighTierPatterns, 'apps/web/**'];
          const { matchesAny } = await import('./packages/config/dist/index.js');
          const needsBrowserEvidence = tier === 'high' && files.some(f => matchesAny(f, allUiPatterns));
          fs.appendFileSync(outputFile, `needs-browser-evidence=${needsBrowserEvidence}\n`);
          EOF
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.files }}

  browser-evidence-gate:
    name: Browser Evidence
    needs: preflight
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Verify browser evidence for high-risk PRs
        env:
          RISK_TIER: ${{ needs.preflight.outputs.risk-tier }}
          NEEDS_BROWSER_EVIDENCE: ${{ needs.preflight.outputs.needs-browser-evidence }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          if [[ "$NEEDS_BROWSER_EVIDENCE" != "true" ]]; then
            echo "Browser evidence is not required for this PR (tier=${RISK_TIER}, needs-browser-evidence=${NEEDS_BROWSER_EVIDENCE})."
            exit 0
          fi

          npm run harness:ui:verify-browser-evidence -- \
            --head-sha "$PR_HEAD_SHA" \
            --manifest "artifacts/browser-evidence/$PR_HEAD_SHA/manifest.json"

  ci-fanout:
    needs: [preflight, browser-evidence-gate]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm -r build

      - name: Run CI checks
        run: |
          echo "Risk tier: ${{ needs.preflight.outputs.risk-tier }}"
          echo "Required checks: ${{ needs.preflight.outputs.required-checks }}"
          echo "Risk score: ${{ needs.preflight.outputs.risk-score }}"
          npm run lint
          npm run test:lint-rules
          npm test
          npm run build
